# 7Keyx3Oct
<!-- pandoc -f markdown -t html5 -o README.html -c github.css README.md -->

4x3のキーを持つマイクロパッド [zero-kb02](https://github.com/sago35/tinygo_keeb_workshop_2024/blob/main/buildguide.md) を電子楽器にするプログラムです。   
ドからシまでの7キーと音域切替キーで3オクターブの音域をカバーしています。＃や♭の半音もサポートしています。  

## Hardware:

TinyGo Keeb Tour 2025で、頒布されたマイクロパッド[zero-kb02](https://github.com/sago35/tinygo_keeb_workshop_2024/blob/main/buildguide.md) を使用しました。  

![zero-kb02](photo/DSCN0151_800x600.jpg)  

このマイクロパッドは、Raspberry Pi Pico と同じRP2040チップを搭載したマイコンボード[RP2040-Zero](https://www.waveshare.com/wiki/RP2040-Zero)で作られています。  
標準では、音を出す機能はないので、拡張コネクタのGPIO14とGNDに[圧電サウンダー,13mm](https://akizukidenshi.com/catalog/g/g104118/)
を接続しています。  

![Piezoelectric Sounder](images/GP14-GND.png)

![圧電サウンダーの取り付け](photo/DSCN0152_800x600.jpg)

## Software:

[TinyGo](https://tinygo.org/) で開発しました。  

キーマトリクスを読み取り、押されたキーの組み合わせをチェックして、対応する音階を圧電サウンダーから出力しています。  

### ファームウェアのインストール  

ソース・ファイルを公開していますが、コンパイルが面倒な方は、以下の手順でコンパイル済みのファームウェアをインストールして下さい。

1. 以下のKeyx3Octのファームウェア(UF2ファイル)をダウンロードして下さい。

> [uf2/7Keyx3Oct.uf2](uf2/7Keyx3Oct.uf2)

2. zero-kb02上のマイコンボード RP2040-ZeroにあるBOOTSELボタンを押しながら、RESETボタンを押して下さい。  
zero-kb02がRPI-RP2ドライブとしてマウントされます。  

3. ダウンロードしたKeyx3OctファームウェアのUF2ファイルをPicoのRPI-RP2ドライブにコピーして下さい。
RP2040-Zeroが、自動的に再起動して、インストールと初期化が完了します。

### 開発環境のインストール  

ソースコードから、インストールしたい方は、開発環境を導入して下さい。  
ここでは、Windows11上での開発環境構築について解説します。他のOSについては、本家サイトの解説をお読み下さい。  

1. パッケージ管理ツールscoopのサイトを開き、導入スクリプトを入手して下さい。  

	[scoop](https://github.com/ScoopInstaller/Scoop)

2. Powershellを開いて、以下のスクリプトを実行して下さい。  

> \> Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser  
> \> Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression  

3. 以下のコマンドを実行して、環境構築は終了です。

> \>scoop install go tinygo

4. 以下のコマンドを実行できれば、正常にインストール
できています。  

> \>tinygo version  
tinygo version 0.38.0 windows/amd64 
(using go version go1.24.4 and LLVM version 19.1.2)

### コンパイル方法  

ソースコードは、[main.go](main.go) です。  
このソースコードのあるディレクトリに移動して、以下のコマンドを実行して下さい。コンパイルが完了すると、生成した実行用バイナリはzero-kb02に転送されます。  

    > tinygo flash --target waveshare-rp2040-zero --size short -monitor .

また、実行用バイナリを転送できない場合は、以下のコマンドで、実行用バイナリを作成し、手作業で、実行用バイナリをzero-kb02に転送して下さい。  

    > tinygo build -o 7Keyx3Oct.uf2 --target waveshare-rp2040-zero --size short .


## キーレイアウトと仕様

このマイクロパッドは、キーの数が、4x3=12個と限られているので、単純に音階をキーに割り当てていくと、全12音で、音域は1オクターブになってしまいます。  
そこで、[かんぷれ](https://kantan-play.com/co/) という楽器を参考にし、以下のようなキーレイアウトにしました。  
7個のキーを音階キーに割当てて、残ったキーを半音とオクターブの切替えに割当て、3オクターブの音域を発音を発音できるようにしました。  

|      |col0 |col1 |col2 |col3 |
| ---- | --- | --- | --- | --- |
| row0 |Oct3 |  7  | ♭  |  #  |
| row1 |     |  4  |  5  |  6  |
| row2 |Oct5 |  1  |  2  |  3  |

![キーレイアウト](photo/DSCN0151_KeyLayout.jpg)

### 音階キー

7Keyx3Oct では、[かんぷれ](https://kantan-play.com/co/) で使われている数字譜を採用しました。  
以下のように、単純に数字が順番にキーに割り振られているだけです。  
基本状態は、4オクターブの7音になっています。
以下が、その対応表です。  

| 数字譜           | 1      | 2      | 3      | 4       | 5      | 6      | 7      |
|:-----------------|:------:|:------:|:------:|:-------:|:------:|:------:|:------:|
| イタリア語音階名 |ド (Do) |レ (Re) |ミ (Mi) |ファ (Fa)|ソ (Sol)|ラ (La) |シ (Si) |
| 日本語音階名     | ハ     | ニ     | ホ     | ヘ      | ト     | イ     | ロ     |
| 英語音階名       | C      | D      | E      | F       | G      | A      | B      |
| ドイツ語音階名   | C      | D      | E      | F       | G      | A      | H      |



#### 機能キー

* 半音キー
    * '#'キー   このキーを押しながら音階キーを押すと、半音上がった音を出力します。

    * '♭'キー   このキーを押しながら音階キーを押すと、半音下げた音を出力します。

* オクターブキー
    * 3 Oct キー
        このキーを押しながら音階キーを押すと、3 オクターブの音を出力します。  
    * 5 Oct キー
        このキーを押しながら音階キーを押すと、5 オクターブの音を出力します。  

オクターブキーを押していない時は、すべて 4 オクターブに設定されます。  


## 数字譜集:

簡単な数字譜の楽譜を用意しました。  

桃太郎

|オクターブ|音階|音長  |
|:--------:|:--:|:-----|
|   Oct4   |  5 |======|
|   Oct4   |  6 |==    |
|          |    |      |
|   Oct4   |  5 |==    |
|   Oct4   |  5 |==    |
|   Oct4   |  3 |====  |
|          |    |      |
|   Oct4   |  5 |==    |
|   Oct4   |  5 |==    |
|   Oct4   |  3 |==    |
|   Oct4   |  1 |==    |
|          |    |      |
|   Oct4   |  2 |======|
|          |  0 |==    |
|          |    |      |
|   Oct4   |  1 |==    |
|   Oct4   |  1 |==    |
|   Oct4   |  2 |==    |
|   Oct4   |  2 |==    |
|          |    |      |
|   Oct4   |  3 |==    |
|   Oct4   |  3 |==    |
|   Oct4   |  2 |====  |
|          |    |      |
|   Oct4   |  3 |==    |
|   Oct4   |  3 |==    |
|   Oct4   |  6 |==    |
|   Oct4   |  6 |==    |
|          |    |      |
|   Oct4   |  5 |======|
|          |  0 |==    |
|          |    |      |
|   Oct5   |  1 |==    |
|   Oct5   |  1 |==    |
|   Oct4   |  5 |====  |
|          |    |      |
|   Oct4   |  3 |==    |
|   Oct4   |  3 |==    |
|   Oct4   |  6 |==    |
|   Oct4   |  6 |==    |
|          |    |      |
|   Oct4   |  5 |==    |
|   Oct4   |  5 |==    |
|   Oct4   |  3 |==    |
|   Oct4   |  2 |==    |
|          |    |      |
|   Oct4   |  1 |======|
|          |  0 |==    |
   

未知との遭遇  

|オクターブ|音階|音長  |
|:--------:|:--:|:-----|
|   Oct5   |  5 |==    |
|   Oct5   |  6 |==    |
|   Oct5   |  4 |==    |
|   Oct4   |  4 |==    |
|   Oct5   |  1 |======|

Thirori Sound

|オクターブ|音階|音長  |
|:--------:|:--:|:-----|
|   Oct5   |  5 |==    |
|   Oct5   |  3 |==    |
|   Oct5   |  5 |==    |
|          |  0 |==    |


歓喜の歌　Ode to Joy  

|オクターブ|音階|音長      |
|:--------:|:--:|:---------|
|   Oct5   |  3 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  4 | ====     |
|   Oct5   |  5 | ====     |
|   Oct5   |  5 | ====     |
|   Oct5   |  4 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  3 | ======   |
|   Oct5   |  2 | ==       |
|   Oct5   |  2 | ======   |
|          |  0 | ==       |
|   Oct5   |  3 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  4 | ====     |
|   Oct5   |  5 | ====     |
|   Oct5   |  5 | ====     |
|   Oct5   |  4 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  2 | ======   |
|   Oct5   |  1 | ==       |
|   Oct5   |  1 | ======   |
|          |  0 | ==       |
|   Oct5   |  2 | ======== |  
|   Oct5   |  3 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  3 | ==       |
|   Oct5   |  4 | ==       |
|   Oct5   |  3 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  3 | ==       |
|   Oct5   |  4 | ==       |
|   Oct5   |  3 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct4   |  5 | ==       |
|          |  0 | ==       |
|   Oct5   |  3 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  4 | ====     |
|   Oct5   |  5 | ====     |
|   Oct5   |  5 | ====     |
|   Oct5   |  4 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  2 | ======   |
|   Oct5   |  1 | ==       |
|   Oct5   |  1 | ==       |
|   Oct5   |  5 | ==       |
|   Oct5   |  4 | ==       |
|   Oct5   |  3 | ==       |
|   Oct5   |  2 | ======== |
|   Oct5   |  3 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  3 | ==       |
|   Oct5   |  4 | ==       |
|   Oct5   |  3 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  3 | ==       |
|   Oct5   |  4 | ==       |
|   Oct5   |  3 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct4   |  5 | ==       |
|          |  0 | ==       |
|   Oct5   |  3 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  4 | ====     |
|   Oct5   |  4 | ====     |
|   Oct5   |  5 | ====     |
|   Oct5   |  5 | ====     |
|   Oct5   |  4 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  1 | ====     |
|   Oct5   |  2 | ====     |
|   Oct5   |  3 | ====     |
|   Oct5   |  2 | ======   |
|   Oct5   |  1 | ==       |
|   Oct5   |  1 | ======== |

